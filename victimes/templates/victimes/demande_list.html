{% extends 'victimes/base.html' %}
{% load static %}

{% block title %}
{% if show_victimes %}Fiches Victimes - Assistant Social{% else %}Liste des Demandes{% endif %} - Gendarmerie
{% endblock %}
{% block breadcrumb %}
{% if show_victimes %}Fiches Victimes pour Demandes{% else %}Demandes d'Aide{% endif %}
{% endblock %}

{% block content %}
{% if show_victimes %}
<!-- Vue pour Assistant Social : Fiches Victimes -->
<div class="chart-container">
    <div class="chart-header">
        <div>
            <div class="chart-title">FICHES VICTIMES AVEC FAMILLES</div>
            <div style="color: #6b7280; font-size: 0.9rem;">Sélectionnez une famille pour créer une demande d'aide</div>
        </div>
        <div>
            <span style="background: #10b98120; color: #10b981; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600;">
                <i class="fas fa-user-check me-2"></i>Assistant Social
            </span>
        </div>
    </div>
    
    <div style="max-height: 600px; overflow-y: auto;">
        {% for victime in victimes %}
        <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid #10b981;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                            <i class="fas fa-user" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #1f2937; font-weight: 600; font-size: 1.2rem;">
                                {{ victime.prenom }} {{ victime.nom }}
                            </h3>
                            <div style="color: #6b7280; font-size: 0.9rem;">
                                {% if victime.date_deces %}
                                Décédé(e) le {{ victime.date_deces|date:"d/m/Y" }}
                                {% endif %}
                                {% if victime.lieu_deces %} - {{ victime.lieu_deces }}{% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if victime.famille %}
                    <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #065f46; font-weight: 600; font-size: 1rem;">
                            <i class="fas fa-users me-2"></i>Famille {{ victime.famille.nom_famille }}
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                            <div><strong>Ville:</strong> {{ victime.famille.ville|default:"Non spécifiée" }}</div>
                            <div><strong>Situation économique:</strong> {{ victime.famille.get_situation_economique_display }}</div>
                            <div><strong>Membres:</strong> {{ victime.famille.membres.count }} personne{{ victime.famille.membres.count|pluralize }}</div>
                        </div>
                        {% if victime.famille.membres.exists %}
                        <div style="margin-top: 10px;">
                            <strong style="color: #065f46;">Membres de la famille:</strong>
                            <div style="margin-top: 5px;">
                                {% for membre in victime.famille.membres.all %}
                                <span style="background: white; color: #047857; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; margin-right: 8px; margin-bottom: 4px; display: inline-block;">
                                    {{ membre.prenom }} {{ membre.nom }} ({{ membre.get_relation_victime_display }})
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div style="margin-left: 20px;">
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <button onclick="viewVictime({{ victime.id }})" 
                                style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: transform 0.2s; font-size: 0.9rem;"
                                onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'"
                                title="Voir les détails complets de la victime">
                            <i class="fas fa-eye me-2"></i>Voir Détails
                        </button>
                        {% if victime.famille %}
                        <button onclick="openDemandeModal({{ victime.famille.id }})" 
                                style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: transform 0.2s; font-size: 0.9rem;"
                                onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'"
                                title="Créer une demande d'aide pour cette famille">
                            <i class="fas fa-hand-holding-heart me-2"></i>Créer Demande
                        </button>
                        {% else %}
                        <div style="background: #fbbf2420; color: #d97706; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; text-align: center;">
                            <i class="fas fa-exclamation-triangle me-2"></i>Famille manquante
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; padding: 40px; color: #6b7280;">
            <i class="fas fa-user-injured" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
            <p>Aucune fiche victime avec famille enregistrée</p>
            <p style="font-size: 0.9rem;">Les agents doivent d'abord créer des fiches victimes avec leurs familles.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal pour créer une demande d'aide -->
<div id="demandeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1002; overflow-y: auto;">
    <div style="background: white; margin: 2% auto; padding: 0; border-radius: 20px; width: 90%; max-width: 700px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); animation: slideIn 0.3s ease;">
        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 25px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 style="margin: 0; font-weight: 700; font-size: 1.5rem;">
                    <i class="fas fa-hand-holding-heart me-2"></i>Nouvelle Demande d'Aide
                </h2>
                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Formuler une demande d'aide pour la famille</p>
            </div>
            <span onclick="closeDemandeModal()" style="font-size: 1.8rem; cursor: pointer; font-weight: bold;">&times;</span>
        </div>
        
        <div style="padding: 30px;">
            <div id="demandeContent">
                <!-- Le contenu sera injecté ici par JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal pour voir les détails d'une victime -->
<div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1003; overflow-y: auto;">
    <div style="background: white; margin: 2% auto; padding: 0; border-radius: 20px; width: 90%; max-width: 900px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); animation: slideIn 0.3s ease;">
        <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 25px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 style="margin: 0; font-weight: 700; font-size: 1.5rem;">
                    <i class="fas fa-user-circle me-2"></i>Détails de la Victime
                </h2>
                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Informations complètes de la victime et de sa famille</p>
            </div>
            <span onclick="closeDetailsModal()" style="font-size: 1.8rem; cursor: pointer; font-weight: bold;">&times;</span>
        </div>
        
        <div style="padding: 30px;">
            <div id="detailsContent">
                <!-- Le contenu sera injecté ici par JavaScript -->
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Vue pour Responsables/Admins : Liste des Demandes -->
<div class="chart-container">
    <div class="chart-header">
        <div>
            <div class="chart-title">DEMANDES D'AIDE</div>
            <div style="color: #6b7280; font-size: 0.9rem;">Gestion des demandes d'aide</div>
        </div>
        <div>
            <a href="{% url 'demande_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nouvelle Demande
            </a>
        </div>
    </div>
    
    <style>
    .demande-assistant-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
        gap: 28px;
        margin-bottom: 18px;
    }
    .demande-assistant-card {
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(59,130,246,0.07);
        padding: 22px 20px 18px 20px;
        display: flex;
        align-items: flex-start;
        gap: 18px;
        transition: box-shadow 0.18s, transform 0.18s;
        position: relative;
        border: 1px solid #e5e7eb;
    }
    .demande-assistant-card:hover {
        box-shadow: 0 8px 32px rgba(59,130,246,0.10);
        transform: translateY(-2px) scale(1.01);
    }
    .demande-assistant-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: #fff;
        margin-right: 8px;
    }
    .demande-assistant-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 0.82rem;
        font-weight: 600;
        margin-left: 8px;
    }
    .demande-assistant-badge.validee { background: #e0f7ef; color: #059669; }
    .demande-assistant-badge.soumise { background: #fef3c7; color: #d97706; }
    .demande-assistant-badge.refusee { background: #fee2e2; color: #ef4444; }
    .demande-assistant-badge.autre { background: #e0e7ef; color: #64748b; }
    .demande-assistant-details {
        flex: 1;
    }
    .demande-assistant-type {
        font-weight: 600;
        color: #1f2937;
        font-size: 1.08rem;
    }
    .demande-assistant-meta {
        font-size: 0.93rem;
        color: #6b7280;
        margin: 2px 0 0 0;
    }
    .demande-assistant-date {
        font-size: 0.8rem;
        color: #9ca3af;
    }
    </style>
    <div class="demande-assistant-grid">
        {% for demande in demandes %}
        <div class="demande-assistant-card">
            <div class="demande-assistant-avatar" style="
                {% if demande.statut == 'validee' %}background: linear-gradient(135deg, #10b981, #059669);
                {% elif demande.statut == 'soumise' %}background: linear-gradient(135deg, #fbbf24, #d97706);
                {% elif demande.statut == 'refusee' %}background: linear-gradient(135deg, #ef4444, #dc2626);
                {% else %}background: linear-gradient(135deg, #64748b, #475569);{% endif %}">
                <i class="fas fa-hands-helping"></i>
            </div>
            <div class="demande-assistant-details">
                <div class="demande-assistant-type">{{ demande.get_type_demande_display }}
                    <span class="demande-assistant-badge {% if demande.statut == 'validee' %}validee{% elif demande.statut == 'soumise' %}soumise{% elif demande.statut == 'refusee' %}refusee{% else %}autre{% endif %}">{{ demande.get_statut_display }}</span>
                </div>
                <div class="demande-assistant-meta"><i class="fas fa-users" style="margin-right: 4px; color: #3b82f6;"></i>Famille {{ demande.famille.nom_famille }}{% if demande.famille.ville %} <span style="margin-left: 8px;"><i class="fas fa-map-marker-alt" style="margin-right: 3px; color: #ef4444;"></i>{{ demande.famille.ville }}</span>{% endif %}</div>
                {% if demande.description %}
                <div class="demande-assistant-meta"><i class="fas fa-quote-left" style="color: #3b82f6; margin-right: 6px; font-size: 0.8rem;"></i>{{ demande.description|truncatechars:60 }}</div>
                {% endif %}
                {% if demande.cree_par %}
                <div class="demande-assistant-date">Créée par : {{ demande.cree_par.username }} | {{ demande.date_creation|date:"d/m/Y" }}</div>
                {% else %}
                <div class="demande-assistant-date">{{ demande.date_creation|date:"d/m/Y" }}</div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; padding: 40px; color: #6b7280; grid-column: 1/-1;">
            <i class="fas fa-hands-helping" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
            <p>Aucune demande d'aide enregistrée</p>
            <a href="{% url 'demande_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Créer la première demande
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if show_victimes %}
<script>
// Token CSRF pour les requêtes AJAX
const csrftoken = '{{ csrf_token }}';

// Fonction pour afficher les alertes
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
    `;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

// Fonctions pour le modal de demande d'aide
function openDemandeModal(familleId) {
    document.getElementById('demandeModal').style.display = 'block';
    document.getElementById('demandeContent').innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="width: 50px; height: 50px; border: 3px solid #10b981; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p style="color: #6b7280; font-size: 1.1rem;">Chargement des informations de la famille...</p>
        </div>
    `;
    
    generateDemandeForm(familleId);
}

function closeDemandeModal() {
    document.getElementById('demandeModal').style.display = 'none';
}

function generateDemandeForm(familleId) {
    const content = `
        <form id="demandeForm">
            <input type="hidden" id="famille_id" value="${familleId}">
            
            <div class="row">
                <div class="col-12 mb-4">
                    <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 12px; padding: 20px; border-left: 4px solid #10b981;">
                        <h5 style="color: #065f46; margin: 0 0 10px 0; font-weight: 600;">
                            <i class="fas fa-info-circle me-2"></i>Information
                        </h5>
                        <p style="color: #047857; margin: 0; font-size: 0.9rem;">
                            Vous allez créer une demande d'aide pour la famille sélectionnée. Veuillez remplir les informations ci-dessous.
                        </p>
                    </div>
                </div>
                
                <div class="col-12 mb-3">
                    <label class="form-label" style="color: #374151; font-weight: 600;">
                        <i class="fas fa-list me-2"></i>Type de demande
                    </label>
                    <select class="form-control" id="type_demande" required>
                        <option value="">Sélectionner le type d'aide...</option>
                        <option value="scolaire">Aide scolaire</option>
                        <option value="allocation">Allocation</option>
                        <option value="logement">Logement</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                
                <div class="col-12 mb-3">
                    <label class="form-label" style="color: #374151; font-weight: 600;">
                        <i class="fas fa-file-alt me-2"></i>Description de la demande
                    </label>
                    <textarea class="form-control" id="description" rows="4" 
                              placeholder="Décrivez en détail la demande d'aide, les besoins de la famille, les justifications..." required></textarea>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px; padding: 20px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-outline-secondary me-3" onclick="closeDemandeModal()">
                    <i class="fas fa-times me-2"></i>Annuler
                </button>
                <button type="submit" class="btn" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
                    <i class="fas fa-paper-plane me-2"></i>Soumettre la demande
                </button>
            </div>
        </form>
    `;
    
    document.getElementById('demandeContent').innerHTML = content;
    
    // Ajouter l'event listener pour le formulaire
    document.getElementById('demandeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitDemande(familleId);
    });
}

function submitDemande(familleId) {
    const formData = new FormData();
    formData.append('famille_id', familleId);
    formData.append('type_demande', document.getElementById('type_demande').value);
    formData.append('description', document.getElementById('description').value);

    // Afficher un indicateur de chargement
    const submitBtn = document.querySelector('#demandeForm button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Envoi en cours...';
    submitBtn.disabled = true;

    // Envoyer les données
    fetch('/demande/creer/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Succès
            closeDemandeModal();
            showAlert('Demande d\'aide soumise avec succès !', 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            // Erreur
            showAlert(data.message || 'Erreur lors de la soumission', 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showAlert('Erreur de connexion lors de la soumission', 'error');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Fonctions pour le modal de détails des victimes
function viewVictime(victimeId) {
    document.getElementById('detailsModal').style.display = 'block';
    document.getElementById('detailsContent').innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="width: 50px; height: 50px; border: 3px solid #3b82f6; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p style="color: #6b7280; font-size: 1.1rem;">Chargement des détails de la victime...</p>
        </div>
    `;
    
    // Récupérer les données via AJAX
    fetch('/victime/details/' + victimeId + '/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayVictimeDetails(data.victime);
        } else {
            document.getElementById('detailsContent').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ef4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>Erreur lors du chargement</h3>
                    <p>${data.message || 'Impossible de charger les données de la victime.'}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        document.getElementById('detailsContent').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <i class="fas fa-wifi" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>Erreur de connexion</h3>
                <p>Impossible de charger les données. Vérifiez votre connexion.</p>
            </div>
        `;
    });
}

function closeDetailsModal() {
    document.getElementById('detailsModal').style.display = 'none';
}

function displayVictimeDetails(victime) {
    const content = `
        <div style="max-height: 70vh; overflow-y: auto;">
            <!-- Informations de la victime -->
            <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid #3b82f6;">
                <h3 style="margin: 0 0 15px 0; color: #1e293b; font-weight: 700; display: flex; align-items: center;">
                    <i class="fas fa-user" style="background: #3b82f6; color: white; padding: 8px; border-radius: 50%; margin-right: 12px; font-size: 1rem;"></i>
                    Informations de la Victime
                </h3>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <i class="fas fa-user-circle" style="color: #3b82f6; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase;">Nom complet</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.nom_complet || 'Non spécifié'}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <i class="fas fa-venus-mars" style="color: #3b82f6; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase;">Sexe</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.sexe_display || 'Non spécifié'}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <i class="fas fa-calendar" style="color: #3b82f6; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase;">Date de naissance</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.date_naissance ? new Date(victime.date_naissance).toLocaleDateString('fr-FR') : 'Non spécifiée'}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                            <i class="fas fa-heart" style="color: #3b82f6; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase;">État civil</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.etat_civil || 'Non spécifié'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations de décès -->
            <div style="background: linear-gradient(135deg, #fffbeb, #fef3c7); border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid #f59e0b;">
                <h3 style="margin: 0 0 15px 0; color: #1e293b; font-weight: 700; display: flex; align-items: center;">
                    <i class="fas fa-cross" style="background: #f59e0b; color: white; padding: 8px; border-radius: 50%; margin-right: 12px; font-size: 1rem;"></i>
                    Informations de Décès
                </h3>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="display: flex; align-items: center; padding: 12px; background: #fffbeb; border-radius: 8px;">
                            <i class="fas fa-calendar-times" style="color: #f59e0b; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #92400e; font-weight: 600; text-transform: uppercase;">Date de décès</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.date_deces_display || 'Non spécifiée'}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; padding: 12px; background: #fffbeb; border-radius: 8px;">
                            <i class="fas fa-map-marker-alt" style="color: #f59e0b; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #92400e; font-weight: 600; text-transform: uppercase;">Lieu de décès</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.lieu_deces || 'Non spécifié'}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; padding: 12px; background: #fffbeb; border-radius: 8px;">
                            <i class="fas fa-graduation-cap" style="color: #f59e0b; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #92400e; font-weight: 600; text-transform: uppercase;">Grade</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.grade || 'Non spécifié'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            ${victime.famille ? `
            <!-- Informations de la famille -->
            <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid #10b981;">
                <h3 style="margin: 0 0 15px 0; color: #1e293b; font-weight: 700; display: flex; align-items: center;">
                    <i class="fas fa-users" style="background: #10b981; color: white; padding: 8px; border-radius: 50%; margin-right: 12px; font-size: 1rem;"></i>
                    Famille ${victime.famille.nom_famille}
                </h3>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; padding: 12px; background: #f0fdf4; border-radius: 8px;">
                            <i class="fas fa-chart-line" style="color: #10b981; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #065f46; font-weight: 600; text-transform: uppercase;">Situation économique</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.famille.situation_economique}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; padding: 12px; background: #f0fdf4; border-radius: 8px;">
                            <i class="fas fa-map-marker-alt" style="color: #10b981; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #065f46; font-weight: 600; text-transform: uppercase;">Adresse</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.famille.adresse || 'Non spécifiée'}</div>
                            </div>
                        </div>
                    </div>
                    ${victime.famille.membres && victime.famille.membres.length > 0 ? `
                    <div>
                        <h4 style="color: #065f46; margin: 0 0 15px 0; font-weight: 600;">Membres de la famille</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            ${victime.famille.membres.map(membre => `
                                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 3px solid #10b981;">
                                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">
                                        <i class="fas fa-user" style="color: #10b981; margin-right: 8px;"></i>
                                        ${membre.prenom} ${membre.nom}
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem;">
                                        <div><strong>Relation:</strong> ${membre.relation_victime_display}</div>
                                        <div><strong>Sexe:</strong> ${membre.sexe}</div>
                                        ${membre.date_naissance ? `<div><strong>Né(e) le:</strong> ${membre.date_naissance}</div>` : ''}
                                        ${membre.profession ? `<div><strong>Profession:</strong> ${membre.profession}</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : '<div style="color: #64748b; font-style: italic;">Aucun membre enregistré</div>'}
                </div>
            </div>
            ` : `
            <div style="background: linear-gradient(135deg, #fffbeb, #fef3c7); border-radius: 15px; padding: 25px; border-left: 5px solid #f59e0b;">
                <h3 style="margin: 0 0 15px 0; color: #1e293b; font-weight: 700; display: flex; align-items: center;">
                    <i class="fas fa-exclamation-circle" style="background: #f59e0b; color: white; padding: 8px; border-radius: 50%; margin-right: 12px; font-size: 1rem;"></i>
                    Famille
                </h3>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center;">
                    <i class="fas fa-users" style="font-size: 2rem; color: #f59e0b; margin-bottom: 10px;"></i>
                    <p style="color: #64748b; margin: 0;">Aucune famille associée à cette victime</p>
                </div>
            </div>
            `}

            <!-- Informations administratives -->
            <div style="background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border-radius: 15px; padding: 25px; border-left: 5px solid #64748b;">
                <h3 style="margin: 0 0 15px 0; color: #1e293b; font-weight: 700; display: flex; align-items: center;">
                    <i class="fas fa-file-alt" style="background: #64748b; color: white; padding: 8px; border-radius: 50%; margin-right: 12px; font-size: 1rem;"></i>
                    Informations Administratives
                </h3>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="display: flex; align-items: center; padding: 12px; background: #f1f5f9; border-radius: 8px;">
                            <i class="fas fa-user-tie" style="color: #64748b; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #475569; font-weight: 600; text-transform: uppercase;">Créé par</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.cree_par || 'Non spécifié'}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; padding: 12px; background: #f1f5f9; border-radius: 8px;">
                            <i class="fas fa-clock" style="color: #64748b; margin-right: 10px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-size: 0.8rem; color: #475569; font-weight: 600; text-transform: uppercase;">Date de création</div>
                                <div style="color: #1e293b; font-weight: 600;">${victime.date_creation || 'Non spécifiée'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px; padding: 20px; border-top: 1px solid #e5e7eb;">
            <button onclick="closeDetailsModal()" class="btn" style="background: linear-gradient(135deg, #64748b, #475569); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600;">
                <i class="fas fa-times me-2"></i>Fermer
            </button>
        </div>
    `;
    
    document.getElementById('detailsContent').innerHTML = content;
}

// CSS animations
const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes slideOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-20px); }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);
</script>
{% endif %}
{% endblock %}
