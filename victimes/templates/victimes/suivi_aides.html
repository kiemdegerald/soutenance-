{% extends 'victimes/base.html' %}
{% load static %}

{% block extra_css %}
<style>
.suivi-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(90deg, #f8fafc 60%, #e0e7ef 100%);
    border-radius: 14px;
    padding: 24px 32px 18px 32px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.suivi-header .chart-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #374151;
    letter-spacing: 1px;
}
.suivi-header .subtitle {
    color: #6b7280;
    font-size: 1rem;
    margin-top: 2px;
}
.suivi-header .btn-group a {
    font-size: 1rem;
    padding: 8px 18px;
    border-radius: 8px;
    font-weight: 600;
    margin-right: 6px;
}
.suivi-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    gap: 22px;
    margin-bottom: 32px;
}
.suivi-stat-card {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    padding: 22px 18px 18px 18px;
    display: flex;
    align-items: center;
    gap: 16px;
}
.suivi-stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    color: #fff;
}
.suivi-stat-details {
    flex: 1;
}
.suivi-stat-details .stat-number {
    font-size: 1.3rem;
    font-weight: 700;
    color: #374151;
}
.suivi-stat-details .stat-label {
    font-size: 0.95rem;
    color: #6b7280;
}
.suivi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(370px, 1fr));
    gap: 28px;
}
.suivi-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    padding: 26px 24px 18px 24px;
    display: flex;
    flex-direction: column;
    transition: box-shadow 0.2s, transform 0.2s;
    position: relative;
}
.suivi-card:hover {
    box-shadow: 0 8px 32px rgba(59,130,246,0.10);
    transform: translateY(-3px) scale(1.01);
}
.suivi-card .suivi-info {
    display: flex;
    align-items: center;
    gap: 18px;
}
.suivi-avatar {
    width: 54px;
    height: 54px;
    background: #e0e7ef;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: #fff;
    box-shadow: 0 2px 8px rgba(102,126,234,0.07);
}
.suivi-badge {
    display: inline-block;
    padding: 7px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-top: 8px;
}
.suivi-badge.validee { background: #e0f7ef; color: #059669; }
.suivi-badge.soumise { background: #fef3c7; color: #d97706; }
.suivi-badge.refusee { background: #fee2e2; color: #ef4444; }
.suivi-badge.autre { background: #e0e7ef; color: #64748b; }
.suivi-card .suivi-details {
    flex: 1;
}
.suivi-card .suivi-details .type {
    font-weight: 600;
    color: #1f2937;
    font-size: 1.13rem;
}
.suivi-card .suivi-details .famille {
    font-size: 0.93rem;
    color: #6b7280;
    margin-top: 2px;
}
.suivi-card .suivi-details .date {
    font-size: 0.82rem;
    color: #9ca3af;
}
.suivi-card .suivi-description {
    background: #f8fafc;
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    border-left: 3px solid #3b82f6;
    color: #4b5563;
    font-size: 0.93rem;
    line-height: 1.5;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="suivi-header">
    <div>
        <div class="chart-title">SUIVI DES AIDES</div>
        <div class="subtitle">Gestion et suivi des demandes d'aide</div>
    </div>
    <div class="btn-group" role="group">
        <a href="{% url 'suivi_aides' %}" class="btn {% if not statut_filtre %}btn-primary{% else %}btn-outline-secondary{% endif %} btn-sm">
            <i class="fas fa-list"></i> Toutes
        </a>
        <a href="{% url 'suivi_aides' %}?statut=soumise" class="btn {% if statut_filtre == 'soumise' %}btn-warning{% else %}btn-outline-warning{% endif %} btn-sm">
            <i class="fas fa-clock"></i> En attente
        </a>
        <a href="{% url 'suivi_aides' %}?statut=validee" class="btn {% if statut_filtre == 'validee' %}btn-success{% else %}btn-outline-success{% endif %} btn-sm">
            <i class="fas fa-check"></i> Validées
        </a>
        <a href="{% url 'suivi_aides' %}?statut=refusee" class="btn {% if statut_filtre == 'refusee' %}btn-danger{% else %}btn-outline-danger{% endif %} btn-sm">
            <i class="fas fa-times"></i> Refusées
        </a>
    </div>
</div>
<div class="suivi-stats">
    <div class="suivi-stat-card">
        <div class="suivi-stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);"><i class="fas fa-file-alt"></i></div>
        <div class="suivi-stat-details">
            <div class="stat-number">{{ stats.total }}</div>
            <div class="stat-label">Total Demandes</div>
        </div>
    </div>
    <div class="suivi-stat-card">
        <div class="suivi-stat-icon" style="background: linear-gradient(135deg, #fbbf24, #d97706);"><i class="fas fa-clock"></i></div>
        <div class="suivi-stat-details">
            <div class="stat-number">{{ stats.en_attente }}</div>
            <div class="stat-label">En Attente</div>
        </div>
    </div>
    <div class="suivi-stat-card">
        <div class="suivi-stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-check"></i></div>
        <div class="suivi-stat-details">
            <div class="stat-number">{{ stats.validees }}</div>
            <div class="stat-label">Validées</div>
        </div>
    </div>
    <div class="suivi-stat-card">
        <div class="suivi-stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);"><i class="fas fa-times"></i></div>
        <div class="suivi-stat-details">
            <div class="stat-number">{{ stats.refusees }}</div>
            <div class="stat-label">Refusées</div>
        </div>
    </div>
</div>
<div class="suivi-grid">
    {% if demandes %}
        {% for demande in demandes %}
        <div class="suivi-card" style="position: relative;">
            <div class="suivi-info">
                <div class="suivi-avatar" style="
                    {% if demande.statut == 'validee' %}background: linear-gradient(135deg, #10b981, #059669); color: #fff;
                    {% elif demande.statut == 'soumise' %}background: linear-gradient(135deg, #fbbf24, #d97706); color: #fff;
                    {% elif demande.statut == 'refusee' %}background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff;
                    {% else %}background: linear-gradient(135deg, #64748b, #475569); color: #fff;{% endif %}">
                    <i class="fas 
                        {% if demande.statut == 'validee' %}fa-check
                        {% elif demande.statut == 'soumise' %}fa-clock
                        {% elif demande.statut == 'refusee' %}fa-times
                        {% else %}fa-question{% endif %}"></i>
                </div>
                <div class="suivi-details">
                    <div class="type">{{ demande.get_type_demande_display }}
                        <span class="suivi-badge {% if demande.statut == 'validee' %}validee{% elif demande.statut == 'soumise' %}soumise{% elif demande.statut == 'refusee' %}refusee{% else %}autre{% endif %}" style="margin-left: 10px;">{{ demande.get_statut_display }}</span>
                    </div>
                    <div class="famille"><i class="fas fa-users" style="margin-right: 5px; color: #3b82f6;"></i>Famille {{ demande.famille.nom_famille }}
                        {% if demande.famille.ville %}<span style="margin-left: 10px;"><i class="fas fa-map-marker-alt" style="margin-right: 5px; color: #ef4444;"></i>{{ demande.famille.ville }}</span>{% endif %}
                    </div>
                    <div class="date">Créée le {{ demande.date_creation|date:"d/m/Y à H:i" }}</div>
                </div>
            </div>
            {% if demande.description %}
            <div class="suivi-description">
                <i class="fas fa-quote-left" style="color: #3b82f6; margin-right: 8px; font-size: 0.8rem;"></i>
                {{ demande.description|truncatechars:120 }}
            </div>
            {% endif %}
            {% if user.role == 'responsable' or user.role == 'admin' %}
            {% if demande.statut == 'soumise' %}
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px;">
                <button onclick="validerDemande({{ demande.id }})" class="btn btn-success btn-sm" style="min-width: 110px; font-weight: 600;">
                    <i class="fas fa-check me-1"></i>Valider
                </button>
                <button onclick="refuserDemande({{ demande.id }})" class="btn btn-danger btn-sm" style="min-width: 110px; font-weight: 600;">
                    <i class="fas fa-times me-1"></i>Refuser
                </button>
            </div>
            {% elif demande.statut == 'validee' or demande.statut == 'refusee' %}
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px;">
                <button onclick="annulerDecision({{ demande.id }})" class="btn btn-warning btn-sm" style="min-width: 200px; font-weight: 600;">
                    <i class="fas fa-undo me-1"></i>Revenir en arrière
                </button>
                {% if demande.valide_par %}
                <span style="font-size: 0.85rem; color: #6b7280; align-self: center;">
                    Traitée par {{ demande.valide_par.first_name }} {{ demande.valide_par.last_name }}
                </span>
                {% endif %}
            </div>
            {% endif %}
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 40px; color: #6b7280; grid-column: 1/-1;">
            <i class="fas fa-hand-holding-heart" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
            <p>Aucune demande d'aide enregistrée</p>
        </div>
    {% endif %}
</div>


<!-- CSS personnalisé -->
<style>
.demande-item:hover {
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    height: 100%;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stat-content {
    display: flex;
    align-items: center;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 20px;
    color: white;
    font-size: 1.5rem;
}

.stat-details {
    flex: 1;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
}

.stat-label {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
    margin-top: 5px;
}

.btn-group .btn {
    border-radius: 8px !important;
    margin-right: 5px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-group .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
</style>

<!-- JavaScript pour les actions -->
<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

function validerDemande(demandeId) {
    if (confirm('Êtes-vous sûr de vouloir valider cette demande ?')) {
        fetch(`/demandes/${demandeId}/valider/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Demande validée avec succès !', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.message || 'Erreur lors de la validation', 'error');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Erreur de connexion', 'error');
        });
    }
}

function refuserDemande(demandeId) {
    if (confirm('Êtes-vous sûr de vouloir refuser cette demande ?')) {
        fetch(`/demandes/${demandeId}/refuser/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Demande refusée avec succès !', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.message || 'Erreur lors du refus', 'error');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Erreur de connexion', 'error');
        });
    }
}

function annulerDecision(demandeId) {
    if (confirm('Êtes-vous sûr de vouloir annuler cette décision et remettre la demande en attente ?')) {
        fetch(`/demandes/${demandeId}/annuler/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Décision annulée, demande remise en attente !', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.message || 'Erreur lors de l\'annulation', 'error');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Erreur de connexion', 'error');
        });
    }
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    `;
    
    if (type === 'success') {
        alertDiv.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    } else if (type === 'error') {
        alertDiv.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
    } else {
        alertDiv.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
    }
    
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

// CSS animations
const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}
@keyframes slideOut {
    from { opacity: 1; transform: translateX(0); }
    to { opacity: 0; transform: translateX(100%); }
}
`;
document.head.appendChild(style);
</script>
{% endblock %}
